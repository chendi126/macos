# åº”ç”¨è¯¦ç»†æ•°æ®è¦†ç›–é—®é¢˜åˆ†æ

## ğŸ” é—®é¢˜å¯¹æ¯”åˆ†æ

é€šè¿‡å¯¹æ¯”æ±‡æ€»æ•°æ®å¯¼å‡ºå’Œåº”ç”¨è¯¦ç»†æ•°æ®å¯¼å‡ºçš„è¦†ç›–é€»è¾‘ï¼Œå‘ç°äº†å…³é”®å·®å¼‚ã€‚

## ğŸ“Š è¦†ç›–ç­–ç•¥å¯¹æ¯”

### **æ±‡æ€»æ•°æ®å¯¼å‡ºï¼ˆå·¥ä½œæ­£å¸¸ï¼‰**
```typescript
// ä½¿ç”¨ UPDATE ç­–ç•¥
const existingRecordId = await this.findSummaryRecordByDate(dayStats.date)

if (existingRecordId) {
  // æ›´æ–°ç°æœ‰è®°å½•
  success = await this.updateRecord(this.config.summaryTableId, existingRecordId, summaryRecord.fields)
  operation = 'updated'
} else {
  // åˆ›å»ºæ–°è®°å½•
  const response = await this.axiosInstance.post(...)
  operation = 'created'
}
```

### **åº”ç”¨è¯¦ç»†æ•°æ®å¯¼å‡ºï¼ˆå¯èƒ½æœ‰é—®é¢˜ï¼‰**
```typescript
// ä½¿ç”¨ DELETE + CREATE ç­–ç•¥
// å…ˆåˆ é™¤ä»Šå¤©çš„ç°æœ‰è®°å½•
await this.deleteRecordsByDate(this.config.tableId, dayStats.date)

// ç„¶åæ’å…¥æ–°è®°å½•
for (let i = 0; i < appRecords.length; i += batchSize) {
  const batch = appRecords.slice(i, i + batchSize)
  // æ‰¹é‡åˆ›å»ºæ–°è®°å½•...
}
```

## ğŸ”§ å¯èƒ½çš„é—®é¢˜åŸå› 

### **1. deleteRecordsByDate æ–¹æ³•é—®é¢˜**

#### **é—®é¢˜1ï¼šæ—¥æœŸå­—æ®µåŒ¹é…å¤±è´¥**
```typescript
// å°è¯•å¤šä¸ªå¯èƒ½çš„æ—¥æœŸå­—æ®µåç§°
const possibleDateFields = ['æ—¥æœŸ', 'Date', 'æ—¶é—´', 'Time', 'date', 'time']
```
**å¯èƒ½åŸå› **ï¼š
- é£ä¹¦è¡¨æ ¼ä¸­çš„å®é™…å­—æ®µåç§°ä¸åœ¨è¿™ä¸ªåˆ—è¡¨ä¸­
- å­—æ®µåç§°æœ‰ç‰¹æ®Šå­—ç¬¦æˆ–ç¼–ç é—®é¢˜
- å­—æ®µç±»å‹ä¸æ˜¯é¢„æœŸçš„æ—¶é—´æˆ³æ ¼å¼

#### **é—®é¢˜2ï¼šæ—¶é—´æˆ³æ ¼å¼ä¸åŒ¹é…**
```typescript
const dateTimestamp = new Date(date).getTime()
// ä¸è®°å½•ä¸­çš„æ—¥æœŸå€¼è¿›è¡Œä¸¥æ ¼ç›¸ç­‰æ¯”è¾ƒ
if (recordDate === dateTimestamp) {
```
**å¯èƒ½åŸå› **ï¼š
- åˆ›å»ºè®°å½•æ—¶çš„æ—¶é—´æˆ³æ ¼å¼ä¸æŸ¥æ‰¾æ—¶ä¸ä¸€è‡´
- æ—¶åŒºå·®å¼‚å¯¼è‡´æ—¶é—´æˆ³ä¸åŒ¹é…
- ç²¾åº¦é—®é¢˜ï¼ˆæ¯«ç§’ vs ç§’ï¼‰

#### **é—®é¢˜3ï¼šAPIæƒé™æˆ–æŸ¥è¯¢é™åˆ¶**
```typescript
// æŸ¥è¯¢æ‰€æœ‰è®°å½•
const response = await this.axiosInstance.get(
  `/bitable/v1/apps/${this.config.appToken}/tables/${tableId}/records`,
  {
    params: {
      page_size: 500 // å¯èƒ½ä¸å¤Ÿå¤§
    }
  }
)
```
**å¯èƒ½åŸå› **ï¼š
- è®°å½•æ€»æ•°è¶…è¿‡500æ¡ï¼Œåˆ†é¡µæŸ¥è¯¢ä¸å®Œæ•´
- APIæƒé™ä¸è¶³ï¼Œæ— æ³•è¯»å–æ‰€æœ‰è®°å½•
- ç½‘ç»œé—®é¢˜å¯¼è‡´æŸ¥è¯¢å¤±è´¥

### **2. æ‰¹é‡åˆ é™¤APIé—®é¢˜**
```typescript
const deleteResponse = await this.axiosInstance.delete(
  `/bitable/v1/apps/${this.config.appToken}/tables/${tableId}/records/batch_delete`,
  {
    data: {
      records: recordsToDelete
    }
  }
)
```
**å¯èƒ½åŸå› **ï¼š
- æ‰¹é‡åˆ é™¤APIæƒé™ä¸è¶³
- åˆ é™¤çš„è®°å½•IDæ ¼å¼ä¸æ­£ç¡®
- ç½‘ç»œè¶…æ—¶æˆ–APIé™åˆ¶

## ğŸ§ª è¯Šæ–­æ–¹æ³•

### **æ–¹æ³•1ï¼šæ£€æŸ¥è¯¦ç»†æ—¥å¿—**
æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼Œé‡ç‚¹å…³æ³¨ï¼š
```
Searching for existing records to delete with date: 2025-07-25 (timestamp: 1753401600000)
Found X total records, searching for date matches...
Target date timestamp: 1753401600000

Checking record recXXXXXX:
  Fields: ["åº”ç”¨åç§°", "ä½¿ç”¨æ—¶é•¿", "æ—¥æœŸ", "å æ¯”"]
  All fields: {
    "åº”ç”¨åç§°": "VSCode",
    "ä½¿ç”¨æ—¶é•¿": 2.5,
    "æ—¥æœŸ": 1753401600000,  // æ£€æŸ¥è¿™ä¸ªå€¼æ˜¯å¦ä¸ç›®æ ‡æ—¶é—´æˆ³åŒ¹é…
    "å æ¯”": 0.35
  }
  Found date field 'æ—¥æœŸ': 1753401600000
âœ… Found record to delete: recXXXXXX (æ—¥æœŸ: 1753401600000)
```

### **æ–¹æ³•2ï¼šå¯¹æ¯”æ±‡æ€»æ•°æ®æŸ¥æ‰¾é€»è¾‘**
æ±‡æ€»æ•°æ®ä½¿ç”¨ç›¸åŒçš„å®¢æˆ·ç«¯ç­›é€‰é€»è¾‘ï¼š
```typescript
// findSummaryRecordByDate æ–¹æ³•
for (const item of response.data.data.items) {
  const recordDate = item.fields['æ—¥æœŸ']
  if (recordDate === dateTimestamp) {
    return item.record_id // æ‰¾åˆ°åŒ¹é…è®°å½•
  }
}
```

å¦‚æœæ±‡æ€»æ•°æ®èƒ½æ‰¾åˆ°è®°å½•ï¼Œåº”ç”¨è¯¦ç»†æ•°æ®ä¹Ÿåº”è¯¥èƒ½æ‰¾åˆ°ã€‚

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### **æ–¹æ¡ˆ1ï¼šç»Ÿä¸€è¦†ç›–ç­–ç•¥**
å°†åº”ç”¨è¯¦ç»†æ•°æ®å¯¼å‡ºæ”¹ä¸ºä¸æ±‡æ€»æ•°æ®ç›¸åŒçš„UPDATEç­–ç•¥ï¼š

```typescript
// ä¸ºåº”ç”¨è¯¦ç»†æ•°æ®å®ç°ç±»ä¼¼çš„æŸ¥æ‰¾å’Œæ›´æ–°é€»è¾‘
async exportAppUsageData(dayStats: DayStats): Promise<ExportSummary> {
  // æŸ¥æ‰¾ç°æœ‰çš„åº”ç”¨è®°å½•
  const existingRecords = await this.findAppRecordsByDate(dayStats.date)
  
  if (existingRecords.length > 0) {
    // åˆ é™¤ç°æœ‰è®°å½•
    await this.deleteSpecificRecords(existingRecords)
  }
  
  // åˆ›å»ºæ–°è®°å½•
  // ...
}
```

### **æ–¹æ¡ˆ2ï¼šæ”¹è¿›deleteRecordsByDateæ–¹æ³•**
```typescript
private async deleteRecordsByDate(tableId: string, date: string): Promise<void> {
  try {
    const dateTimestamp = new Date(date).getTime()
    
    // åˆ†é¡µæŸ¥è¯¢æ‰€æœ‰è®°å½•
    let allRecords = []
    let hasMore = true
    let pageToken = ''
    
    while (hasMore) {
      const response = await this.axiosInstance.get(
        `/bitable/v1/apps/${this.config.appToken}/tables/${tableId}/records`,
        {
          params: {
            page_size: 500,
            page_token: pageToken
          }
        }
      )
      
      if (response.data.code === 0 && response.data.data) {
        allRecords.push(...response.data.data.items)
        hasMore = response.data.data.has_more
        pageToken = response.data.data.page_token || ''
      } else {
        break
      }
    }
    
    // ç­›é€‰åŒ¹é…çš„è®°å½•
    const recordsToDelete = allRecords.filter(item => {
      return item.fields['æ—¥æœŸ'] === dateTimestamp
    }).map(item => item.record_id)
    
    // æ‰¹é‡åˆ é™¤
    if (recordsToDelete.length > 0) {
      await this.batchDeleteRecords(tableId, recordsToDelete)
    }
  } catch (error) {
    console.error('Error deleting records by date:', error)
  }
}
```

### **æ–¹æ¡ˆ3ï¼šæ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†**
```typescript
private async deleteRecordsByDate(tableId: string, date: string): Promise<void> {
  try {
    // ... ç°æœ‰é€»è¾‘
    
    if (recordsToDelete.length > 0) {
      console.log(`Found ${recordsToDelete.length} existing records for date ${date}, deleting...`)
      console.log(`Records to delete:`, recordsToDelete)
      
      const deleteResponse = await this.axiosInstance.delete(
        `/bitable/v1/apps/${this.config.appToken}/tables/${tableId}/records/batch_delete`,
        {
          data: {
            records: recordsToDelete
          }
        }
      )

      console.log(`Delete response:`, deleteResponse.data)
      
      if (deleteResponse.data.code === 0) {
        console.log(`âœ… Successfully deleted ${recordsToDelete.length} existing records for date ${date}`)
      } else {
        console.error(`âŒ Failed to delete existing records: ${deleteResponse.data.msg}`)
        console.error(`Delete response details:`, JSON.stringify(deleteResponse.data, null, 2))
      }
    } else {
      console.log(`No existing records found for date ${date}`)
    }
  } catch (error) {
    console.error('Error deleting records by date:', error)
    if (error.response) {
      console.error('Error response:', error.response.data)
    }
  }
}
```

## ğŸ¯ æ¨èçš„è°ƒè¯•æ­¥éª¤

### **æ­¥éª¤1ï¼šæ”¶é›†è¯¦ç»†æ—¥å¿—**
1. æ‰§è¡Œåº”ç”¨è¯¦ç»†æ•°æ®å¯¼å‡º
2. æŸ¥çœ‹æ§åˆ¶å°çš„å®Œæ•´æ—¥å¿—è¾“å‡º
3. é‡ç‚¹å…³æ³¨ï¼š
   - æ˜¯å¦æ‰¾åˆ°äº†ç°æœ‰è®°å½•
   - æ—¥æœŸå­—æ®µçš„å€¼æ˜¯å¦åŒ¹é…
   - åˆ é™¤æ“ä½œæ˜¯å¦æˆåŠŸ

### **æ­¥éª¤2ï¼šå¯¹æ¯”æ±‡æ€»æ•°æ®å¯¼å‡º**
1. æ‰§è¡Œæ±‡æ€»æ•°æ®å¯¼å‡º
2. è§‚å¯Ÿæ˜¯å¦èƒ½æˆåŠŸæ‰¾åˆ°å’Œæ›´æ–°è®°å½•
3. å¯¹æ¯”ä¸¤ç§å¯¼å‡ºçš„æ—¥å¿—å·®å¼‚

### **æ­¥éª¤3ï¼šæ‰‹åŠ¨éªŒè¯é£ä¹¦è¡¨æ ¼**
1. åœ¨é£ä¹¦è¡¨æ ¼ä¸­æŸ¥çœ‹åº”ç”¨è¯¦ç»†æ•°æ®
2. ç¡®è®¤æ—¥æœŸå­—æ®µçš„å®é™…åç§°å’Œæ ¼å¼
3. æ£€æŸ¥æ˜¯å¦æœ‰æƒé™é—®é¢˜

### **æ­¥éª¤4ï¼šå®æ–½ä¿®å¤**
æ ¹æ®æ—¥å¿—åˆ†æç»“æœï¼Œé€‰æ‹©åˆé€‚çš„è§£å†³æ–¹æ¡ˆè¿›è¡Œä¿®å¤ã€‚

## ğŸ“ æ€»ç»“

åº”ç”¨è¯¦ç»†æ•°æ®ä¸è¦†ç›–çš„é—®é¢˜å¾ˆå¯èƒ½å‡ºç°åœ¨`deleteRecordsByDate`æ–¹æ³•ä¸­ï¼Œä¸»è¦å¯èƒ½çš„åŸå› åŒ…æ‹¬ï¼š

1. **æ—¥æœŸå­—æ®µåŒ¹é…å¤±è´¥**
2. **æ—¶é—´æˆ³æ ¼å¼ä¸ä¸€è‡´**
3. **APIæƒé™æˆ–æŸ¥è¯¢é™åˆ¶**
4. **æ‰¹é‡åˆ é™¤æ“ä½œå¤±è´¥**

å»ºè®®å…ˆé€šè¿‡è¯¦ç»†æ—¥å¿—ç¡®å®šå…·ä½“çš„å¤±è´¥ç‚¹ï¼Œç„¶åé’ˆå¯¹æ€§åœ°è¿›è¡Œä¿®å¤ã€‚
